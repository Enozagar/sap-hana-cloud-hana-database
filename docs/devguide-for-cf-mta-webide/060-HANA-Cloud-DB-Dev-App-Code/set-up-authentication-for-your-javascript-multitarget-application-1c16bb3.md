<!-- loio1c16bb3a51b247c796064b215c01823d -->

# Set up Authentication for your JavaScript Multitarget Application

Instructions to help you set up user authentication for your JavaScript multitarget application in Cloud Foundry.



<a name="loio1c16bb3a51b247c796064b215c01823d__prereq_ogg_tlf_21b"/>

## Prerequisites

-   You have configured you command-line interface to use the public NPM registry. For more information, see *Related Links* below.

-   The tutorials in this section require tools provided with the CF command-line client, but you can also use graphical developer tools, for example, *SAP Web IDE Full-Stack*.




## Context

The User Account and Authentication \(UAA\) service uses OAuth2 to implement authentication and authorization in the loud Foundry run time. For more information, see *Maintaining Application Security* in the *Related Links* below.



## Procedure

1.  Create a UAA service instance named `myuaa`.

    ```
    cf create-service xsuaa default myuaa
    ```

2.  Add the *myuaa* service to the application's `manifest.yml` file.

    The updated `manifest.yml` should look like the following example:

    ```
    ---
    applications:
    - name: myapp
      path: myapp
      services:
        - myhana
        - myuaa
    ```

    The JavaScript run time will bind the *myuaa* service instance \(as well as *myhana*\) to the *myapp* application during deployment.

    > ### Note:  
    > Authentication and authorization are topics that are related to more components than just one application.

    The application run time supports the microservices concept in which a single business application my contain several different applications \(microservices\). A single entry point for these microservices is provided by the application router \(`@sap/approuter`\). The application router receives all the requests, performs authentication, and forwards the authenticated requests to the appropriate microservice along with a JSON Web Token \(JWT\). The application router can also perform first-level authorization.

3.  To complete the authorization part of the tutorial you have to add one more application - the application router.
4.  Create a directory named `web` in the `node-tutorial` directory.

5.  In the `web` directory, create a subdirectory named `resources`.

6.  In the `resources` directory, create file `index.html` and add the following content.

    ```
    <html>
    <head>
        <title>JavaScript Tutorial</title>
    </head>
    <body>
      <h1>JavaScript Tutorial</h1>
      <a href="/myapp/">myapp</a>
    </body>
    </html>
    ```

    This will be the application's entry page.

7.  Create a `package.json` file in the `web` directory with the following content:

    ```
    {
        "name": "myapp-entry-point",
        "scripts": {
            "start": "node node_modules/@sap/approuter/approuter.js"
        }
    }
    ```

8.  In the `web` directory execute `npm install @sap/approuter --save` to install the `@sap/approuter` module and add it as a dependency in the `package.json` file.

    After the installation of the package is complete, the dependencies section in the `package.json` file should have the following content:

    ```
      "dependencies": {
        "@sap/approuter": "^2.7.0"
      },
    ```

9.  Add the following content to the end of the `manifest.yml` file in the `node-tutorial` directory:

    ```
    - name: web
      path: web
      env:
        destinations: >
          [
            {
              "name":"myapp",
              "url":"<myapp url>",
              "forwardAuthToken": true
            }
          ]
      services:
        - myuaa
    ```

    The `destinations` environment variable defines the destinations to which the application router forwards requests.

    Set the `url` property to the URL of the `myapp` application, which is displayed in the output generated by the command: `cf app myapp --urls`.

    > ### Note:  
    > The `myuaa` service is bound to the `web` application during deployment.

10. Create the application descriptor \(`xs-app.json`\) in the `web` directory and add the following content:

    ```
    {
      "routes": [
        {
          "source": "^/myapp/(.*)$",
          "target": "$1",
          "destination": "myapp"
        }
      ]
    }
    ```

11. In the `myapp` execute `npm install @sap/xssec --save` to install the `@sap/xssec` module and add it as a dependency in the `package.json` file.

12. Execute `npm install passport --save` to install the `passport` module and add it as a dependency in the `package.json` file.

    The list of dependencies should look like the following example:

    ```
    "dependencies": {
      "express": "4.16.2",
      "@sap/xsenv": "^1.2.9",
      "@sap/hdbext": "^5.0.0",
      "@sap/xssec": "^2.1.6",
      "passport": "^0.3.2"
    }
    ```

13. Verify that the request is authenticated by checking the JWT token included in the request.

    Replace the content of the application startup file \(`myapp/start.js`\) with the following.

    ```
    var express = require('express');
    var xsenv = require('@sap/xsenv');
    var passport = require('passport');
    var JWTStrategy = require('@sap/xssec').JWTStrategy;
    
    var app = express();
    
    var services = xsenv.getServices({ hana:'myhana', uaa:'myuaa' });
    
    passport.use(new JWTStrategy(services.uaa));
    
    app.use(passport.initialize());
    app.use(passport.authenticate('JWT', { session: false }));
    
    app.get('/', function (req, res, next) {
      res.send('Application user: ' + req.user.id + '<br>' + 'HANA user: ' + services.hana.user);
    });
    
    var port = process.env.PORT || 3000;
    app.listen(port, function () {
      console.log('myapp listening on port ' + port);
    });
    ```

14. Go to the `node-tutorial` directory and deploy the application by executing the following command.

    ```
    xs push
    ```

    This command updates the `myapp` application and also deploys the `web` application.

    > ### Note:  
    > From this point in the tutorial we make requests using the URL of the `web` application, which forwards the requests to the *myapp* application.

15. Find the URL of the `web` application using the `cf apps` command.

16. Request the `web` application with path `/myapp/`.

17. Enter the credentials of a valid user. If no custom identity provider \(IDP\) is configured, you should use the credential of a known SAP HANA user.

    You should see a message similar to the following in the browser:

    -   *Application user: *<login user\>**

        The name of the user who logs on to the application.

    -   *HANA user: *<db user\>**

        The technical user used to connect to SAP HANA.


    > ### Note:  
    > An application user is not the same as a database user.

    > ### Note:  
    > Both `myapp` and `web` applications are bound to the same UAA service instance - `myapp`. In this scenario authentication is handled by the `web` application.


**Related Information**  


[Maintaining Application Security in Cloud Foundry on SAP BTP](../100-HANA-Cloud-DB-Dev-Security/maintaining-application-security-in-cloud-foundry-on-sap-btp-35d910e.md "Set up the security components required in the context of multitarget applications on SAP BTP .")

[Standard SAP Node.js Packages](standard-sap-node-js-packages-5451327.md "A collection of Node.js packages developed by SAP is provided to help you develop Node.js applications for Cloud Foundry and SAP HANA Cloud.")

[The NPM Registry](the-npm-registry-726e5d4.md "The public NPM registry includes SAP Node.js modules for use by application developers.")

